// Test with 5 bodies

struct Body {
    x: f64,
    y: f64,
    z: f64,
    vx: f64,
    vy: f64,
    vz: f64,
    mass: f64,
}

fn update_velocity(b1: &mut Body, b2: &mut Body, dt: f64) {
    let dx = b1.x - b2.x;
    let dy = b1.y - b2.y;
    let dz = b1.z - b2.z;

    let dist_sq = dx * dx + dy * dy + dz * dz;
    let mag = dt / dist_sq;

    b1.vx = b1.vx - dx * b2.mass * mag;
    b1.vy = b1.vy - dy * b2.mass * mag;
    b1.vz = b1.vz - dz * b2.mass * mag;

    b2.vx = b2.vx + dx * b1.mass * mag;
    b2.vy = b2.vy + dy * b1.mass * mag;
    b2.vz = b2.vz + dz * b1.mass * mag;
}

fn advance_pos(b: &mut Body, dt: f64) {
    b.x = b.x + dt * b.vx;
    b.y = b.y + dt * b.vy;
    b.z = b.z + dt * b.vz;
}

fn main() {
    let mut b0 = Body { x: 0.0, y: 0.0, z: 0.0, vx: 0.0, vy: 0.0, vz: 0.0, mass: 1.0 };
    let mut b1 = Body { x: 1.0, y: 0.0, z: 0.0, vx: 0.0, vy: 0.0, vz: 0.0, mass: 0.1 };
    let mut b2 = Body { x: 2.0, y: 0.0, z: 0.0, vx: 0.0, vy: 0.0, vz: 0.0, mass: 0.1 };
    let mut b3 = Body { x: 3.0, y: 0.0, z: 0.0, vx: 0.0, vy: 0.0, vz: 0.0, mass: 0.1 };
    let mut b4 = Body { x: 4.0, y: 0.0, z: 0.0, vx: 0.0, vy: 0.0, vz: 0.0, mass: 0.1 };

    println_str("Running 100 steps...");

    // Run 100 steps
    let mut i = 0;
    while i < 100 {
        // All pairwise interactions
        update_velocity(&mut b0, &mut b1, 0.01);
        update_velocity(&mut b0, &mut b2, 0.01);
        update_velocity(&mut b0, &mut b3, 0.01);
        update_velocity(&mut b0, &mut b4, 0.01);
        update_velocity(&mut b1, &mut b2, 0.01);
        update_velocity(&mut b1, &mut b3, 0.01);
        update_velocity(&mut b1, &mut b4, 0.01);
        update_velocity(&mut b2, &mut b3, 0.01);
        update_velocity(&mut b2, &mut b4, 0.01);
        update_velocity(&mut b3, &mut b4, 0.01);

        advance_pos(&mut b0, 0.01);
        advance_pos(&mut b1, 0.01);
        advance_pos(&mut b2, 0.01);
        advance_pos(&mut b3, 0.01);
        advance_pos(&mut b4, 0.01);

        i = i + 1;
    }

    println_str("After 100 steps:");
    println_f64(b0.x);
    println_f64(b4.x);
}
